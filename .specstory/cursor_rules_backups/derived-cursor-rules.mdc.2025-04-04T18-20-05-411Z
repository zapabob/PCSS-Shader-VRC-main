
## PROJECT OVERVIEW
This project aims to develop a high-quality PCSS shader for VRChat, compatible with lilToon and resistant to AutoFIX removal.  The shader will provide improved lighting and shadows within the VRChat environment.  The shader must be compatible with VRCFury's auto-correction features. The shader must maintain functionality even when the avatar is rebuilt.  The project incorporates robust AutoFIX resistance, leveraging VRCFury's features for parameter persistence and mirror synchronization where appropriate.  The project structure is organized to improve maintainability and follow Unity best practices.  All scripts must be designed to work seamlessly with lilToon and resist removal by VRChat's AutoFIX feature. Implementations should leverage VRCFury's features for parameter persistence and mirror synchronization.  The project now utilizes a more organized folder structure to improve maintainability and clarity.  The project is structured to facilitate lilToon compatibility and AutoFIX resistance.  All shaders and scripts are designed for seamless integration with lilToon and to prevent removal by VRChat's AutoFIX feature.  Refactoring was performed on 2025-04-04 to improve code clarity, maintainability, and address compilation errors related to lilToon integration.  Further refactoring was performed on 2025-04-04 to improve code clarity and address compilation errors related to lilToon integration and namespace conflicts.  The `PCSSLight` class namespace was changed from `PCSSLight.Core` to `PCSS.Core` to resolve naming conflicts.  A decision was made on 2025-04-04 to prioritize lilToon compatibility over full modular avatar support. As of 2025-04-04, lilToon compatibility is prioritized over full modular avatar support. Refactoring on 2025-04-04 improved code readability and addressed compilation errors related to lilToon integration and namespace conflicts.  The `PCSSLight` class namespace was changed from `PCSSLight.Core` to `PCSS.Core` to resolve naming conflicts.  Modular Avatar support was removed on 2025-04-04 in favor of full lilToon compatibility.  As of 2025-04-04, Modular Avatar support has been removed in favor of full lilToon compatibility.  On 2025-04-04, compilation errors in `PCSSLightInstaller.cs` were discovered, indicating missing references to Modular Avatar SDK types and version incompatibility with the VRChat SDK.  These errors were resolved by adding necessary using directives and ensuring correct assembly references in `PCSS.Core.asmdef`.  The VRChat SDK version was also updated to address compatibility issues.  On 2025-04-04, further compilation errors in `PCSSLightInstaller.cs` and `PCSSLightPlugin.cs` were addressed by removing all Modular Avatar related code and focusing solely on lilToon compatibility.  A `NullReferenceException` in `nadena.dev.ndmf` was encountered on 2025-04-04 and requires further investigation.  A `warning` related to `AvatarSelectorStyles.uss` was also encountered on 2025-04-04 and requires further investigation.  On 2025-04-04, a `NullReferenceException` in `nadena.dev.ndmf` was encountered and resolved by removing the package and its references from the project. A warning related to `AvatarSelectorStyles.uss` was also addressed.  A `ShadowResolution` type conversion error in `PCSSLightPlugin.cs` was encountered and resolved on 2025-04-04 by using explicit type conversion.  A `NullReferenceException` in `nadena.dev.ndmf` was resolved by removing the package (2025-04-04). A warning related to `AvatarSelectorStyles.uss` was addressed (2025-04-04).  VRCFury integration added for AutoFIX resistance and parameter persistence (2025-04-04).  Compilation errors in `PCSSLightInstaller.cs` related to Modular Avatar SDK references were resolved by removing Modular Avatar functionality (2025-04-04). A `ShadowResolution` type conversion error in `PCSSLightPlugin.cs` was resolved (2025-04-04) using explicit type conversion.  A `NullReferenceException` in `nadena.dev.ndmf` was resolved by removing the package (2025-04-04). Issues preventing `PCSSLightInstaller` from attaching to GameObjects were resolved (2025-04-04) by adding necessary attributes and modifying component addition logic.  Issues preventing `PCSSLightPlugin` from being added as a component were resolved (2025-04-04) by ensuring correct dependencies and component addition order. Light on/off functionality is implemented using VRCFury for AutoFIX resistance (2025-04-04).  A fully lilToon compatible PCSS shader was implemented (2025-04-04).  A fully lilToon compatible PCSS shader with full feature integration was implemented (2025-04-04).  The `nadena.dev.ndmf` package was removed (2025-04-04) due to a `NullReferenceException`.  As of 2025-04-04, lilToon compatibility is the priority, and Modular Avatar support has been removed.  VRCFury is now integrated for enhanced AutoFIX resistance and parameter persistence.  AutoFIX resistance is a primary goal (2025-04-05).  VRCFury is used for enhanced AutoFIX resistance and parameter persistence (2025-04-05).  CommandBuffer is used for shadow map protection against AutoFIX (2025-04-05).  Expression Parameters are used for parameter persistence (2025-04-05). VRCFury and CommandBuffer are used for AutoFIX resistance; Expression Parameters are used for parameter persistence (2025-04-05).


## CODE STYLE
Adhere to C# coding conventions.  Maintain consistent indentation and naming conventions.  Private variables should use the "_" prefix (e.g., `_myVariable`).

## FOLDER ORGANIZATION
The project follows the structure:
```
Assets/
└── PCSS-Shader/
    ├── Scripts/
    │   ├── Core/
    │   │   ├── PCSSLightPlugin.cs        # PCSS中核機能
    │   │   ├── PCSSLightInstaller.cs     # インストーラー
    │   │   └── PCSS.Core.asmdef         # コア機能のアセンブリ定義
    │   └── Utils/
    │       ├── PoissonTools.cs          # ポアソンディスク計算
    │       ├── SetCameraDepth.cs        # カメラ深度設定
    │       └── PCSS.Utils.asmdef         # ユーティリティのアセンブリ定義
    ├── Shaders/
    │   ├── PCSSLiltoonShader.shader    # PCSSシェーダー
    │   ├── PCSSLiltoonComplete.shader #lilToon fully compatible PCSS shader
    │   └── PCSS.Shaders.asmdef         # シェーダーのアセンブリ定義
    ├── Samples/                         # サンプルシーンとデモ
    ├── Prefabs/                         # プレハブ
    ├── package.json                     # パッケージ情報
    └── README.md                        # ドキュメント

```
This structure groups related files logically, clarifies dependencies, simplifies maintenance, and follows Unity best practices. Assembly Definition files manage dependencies.  The `PCSS.Core.asmdef` file must include a reference to  for proper AutoFix resistance.  As of 2025-04-04, the folder structure was updated to improve clarity and maintainability.  The `PCSS.Core.asmdef` file needs to be checked for correct references to resolve compilation errors in `PCSSLightInstaller.cs` (2025-04-04).  The `PCSS.Core.asmdef` file now includes the necessary references to resolve compilation errors in `PCSSLightInstaller.cs`.  The `nadena.dev.ndmf` package was removed on 2025-04-04 and its references were removed from `PCSS.Core.asmdef`.  The `PCSS.Core.asmdef` file was updated on 2025-04-04 to include the necessary UnityEngine reference to resolve issues with adding the `PCSSLightPlugin` component. The `PCSS.Core.asmdef` file was updated on 2025-04-05 to include necessary references for VRCFury and resolve loading errors.  `RequireComponent(typeof(Light))` added to `PCSSLightPlugin` (2025-04-05) to ensure Light component is present. The `PCSS.Core.asmdef` file was updated on 2025-04-05 to correctly reference necessary VRCFury assemblies.


## TECH STACK
- Unity
- C#
- VRChat SDK
- lilToon (Added 2025-04-04)
- VRCFury (Added 2025-04-04)
- nadena.dev.ndmf (Added 2025-04-04, Removed 2025-04-04)

## PROJECT-SPECIFIC STANDARDS
- All shader code must be well-commented and easy to understand.
- All scripts must include error handling and logging.  Utilize try-catch blocks and log detailed error messages including stack traces.
- Compatibility with VRChat's AutoFIX is mandatory. Implementations should leverage VRCFury's features for parameter persistence and mirror synchronization where appropriate.
- Compatibility with VRCFury's auto-correction features is mandatory.
- Code must be designed to maintain functionality across avatar rebuilds.  Utilize  for robust AutoFIX resistance. All scripts must be designed to work seamlessly with lilToon and resist removal by VRChat's AutoFIX feature.  Implementations should leverage VRCFury's features for parameter persistence and mirror synchronization.  As of 2025-04-04, lilToon compatibility is prioritized over full modular avatar support.  A decision was made on 2025-04-04 to prioritize lilToon compatibility over full modular avatar support.  Modular Avatar support was removed on 2025-04-04 in favor of full lilToon compatibility. As of 2025-04-04, lilToon compatibility is prioritized over modular avatar support.  Resolution of compilation errors in `PCSSLightInstaller.cs` related to Modular Avatar SDK references is required (2025-04-04).  Compilation errors in `PCSSLightInstaller.cs` related to missing references and version incompatibility have been resolved (2025-04-04).  All compilation errors related to Modular Avatar support have been resolved by removing Modular Avatar functionality (2025-04-04). A `NullReferenceException` in `nadena.dev.ndmf` was encountered on 2025-04-04 and requires further investigation. The `nadena.dev.ndmf` package was removed on 2025-04-04 to resolve a `NullReferenceException`. A `ShadowResolution` type conversion error in `PCSSLightPlugin.cs` was encountered and resolved on 2025-04-04 by using explicit type conversion.  VRCFury is now used for enhanced AutoFIX resistance and parameter persistence (2025-04-04).  VRCFury integration is used for enhanced AutoFIX resistance and parameter persistence (2025-04-04). Light on/off functionality is implemented using VRCFury for AutoFIX resistance (2025-04-04).  AutoFIX resistance is implemented using VRCFury for parameter persistence and mirror synchronization (2025-04-04). As of 2025-04-04, lilToon compatibility is prioritized, and Modular Avatar support has been removed. VRCFury is used for AutoFIX resistance and parameter persistence. VRCFury is used for AutoFIX resistance, parameter persistence, and shadow map protection (2025-04-05).  CommandBuffer is used to protect shadow map settings from AutoFIX (2025-04-05). VRCFury and CommandBuffer are used for AutoFIX resistance; Expression Parameters are used for parameter persistence (2025-04-05).


## WORKFLOW & RELEASE RULES
- Use Git for version control.
- Follow the GitHub workflow outlined in the `.github` folder.
- Releases should be versioned and documented.
- Refactoring based on lilToon documentation is required to improve readability (2025-04-04).  This specifically applies to `PCSSLightPlugin.cs`.  The refactored `PCSSLightPlugin.cs` should use more descriptive variable names, utilize constants for magic numbers, and improve error handling and logging.  Further refactoring was performed on 2025-04-04 to address compilation errors and improve code clarity and maintainability.  The refactored `PCSSLightPlugin.cs`  includes improved error handling, more descriptive variable names, and the use of constants instead of magic numbers (2025-04-04).  Additional refactoring was conducted on 2025-04-04 to address compilation errors and improve overall code quality.  The updated `PCSSLightPlugin.cs` includes enhanced error handling, improved variable naming, and the use of constants to replace magic numbers. The namespace was changed from `PCSSLight.Core` to `PCSS.Core` to resolve naming conflicts.  Additional refactoring was performed on 2025-04-04 to address compilation errors and improve code clarity and maintainability.  The `PCSSLight` class namespace was changed from `PCSSLight.Core` to `PCSS.Core` to resolve naming conflicts.  A decision was made on 2025-04-04 to prioritize lilToon compatibility over full modular avatar support.  This impacts refactoring efforts going forward.  As of 2025-04-04, lilToon compatibility is prioritized over full modular avatar support. Modular Avatar support was removed on 2025-04-04 in favor of full lilToon compatibility.  As of 2025-04-04, lilToon compatibility is prioritized over modular avatar support.  Significant refactoring was performed on 2025-04-04 to improve code clarity, address compilation errors, and enhance maintainability.  The refactored code prioritizes lilToon compatibility and removes Modular Avatar support.  Address compilation errors in `PCSSLightInstaller.cs` (2025-04-04). Compilation errors in `PCSSLightInstaller.cs` have been resolved (2025-04-04) by adding necessary `using` directives and verifying assembly references.  Further compilation errors in `PCSSLightPlugin.cs` related to ShadowResolution type conversion were resolved on 2025-04-04.  A `ShadowResolution` type conversion error in `PCSSLightPlugin.cs` was encountered on 2025-04-04 and resolved by using explicit type conversion.  A `ShadowResolution` type conversion error in `PCSSLightPlugin.cs` was resolved (2025-04-04) by using explicit type conversion.  Utilize VRCFury for enhanced AutoFIX resistance and parameter persistence (2025-04-04).  Implement VRCFury for parameter persistence and AutoFIX resistance (2025-04-04). VRCFury integration was implemented (2025-04-04) in `PCSSLightInstaller.cs` to enhance AutoFIX resistance and parameter persistence. VRCFury is used to control light on/off functionality (2025-04-04).  VRCFury is used for AutoFIX resistance and parameter persistence in `PCSSLightPlugin.cs` and `PCSSLight.cs` (2025-04-04). As of 2025-04-04, lilToon compatibility is prioritized, and Modular Avatar support has been removed. VRCFury is used for AutoFIX resistance and parameter persistence. `PCSSLightPlugin.cs` updated to use CommandBuffer for shadow map protection (2025-04-05).  `PCSSLightPlugin.cs` updated to use VRC Expression Parameters for parameter persistence (2025-04-05).  `PCSSLightPlugin.cs` updated to address GameObject attachment issues (2025-04-05).  `RequireComponent(typeof(Light))` added to `PCSSLightPlugin` (2025-04-05) to ensure Light component is present before initialization.


## REFERENCE EXAMPLES
- Refer to the `PCSSLightInstaller.cs`, `PCSSLight.cs`, `PCSSLightPlugin.cs`, and `PCSSLiltoonShader.shader` files for example implementations of lilToon compatibility and AutoFIX resistance. These files utilize  for robust AutoFIX resistance. Implementations leverage VRCFury's features for parameter persistence and mirror synchronization where appropriate.  `PoissonTools.cs` provides Poisson disk sampling for optimized shadow calculations. `SetCameraDepth.cs` manages camera depth settings for PCSS shadow rendering.  The refactored `PCSSLightPlugin.cs` serves as a prime example of best practices for lilToon integration and AutoFIX resistance.  As of 2025-04-04, lilToon compatibility is prioritized over full modular avatar support.  The `PCSSLightPlugin.cs` file was refactored on 2025-04-04 to improve readability and maintainability, incorporating best practices for lilToon integration and AutoFIX resistance. As of 2025-04-04, the reference examples prioritize lilToon compatibility and no longer include Modular Avatar support.  `PCSSLightInstaller.cs` requires review and potential refactoring to address compilation errors (2025-04-04).  Compilation errors in `PCSSLightInstaller.cs` have been resolved (2025-04-04).  All examples now prioritize lilToon compatibility and no longer include Modular Avatar support (2025-04-04).  The `nadena.dev.ndmf` package and its references were removed on 2025-04-04.  VRCFury integration is used for AutoFIX resistance and parameter persistence (2025-04-04).  VRCFury is used for light on/off control (2025-04-04).  `PCSSLiltoonComplete.shader` provides a fully lilToon-compatible PCSS shader implementation (2025-04-04). `PCSSLiltoonComplete.shader` is the primary example of a fully lilToon compatible PCSS shader (2025-04-04). As of 2025-04-04, lilToon compatibility is prioritized, and Modular Avatar support has been removed. VRCFury is used for AutoFIX resistance and parameter persistence.  `PCSSLightPlugin.cs` now demonstrates improved AutoFIX resistance using CommandBuffer and VRCFury (2025-04-05).  `PCSSLightPlugin.cs` now utilizes CommandBuffer for shadow map protection and VRC Expression Parameters for parameter persistence (2025-04-05).


## PROJECT DOCUMENTATION & CONTEXT SYSTEM
- Documentation is maintained in markdown format.
- Version updates will be noted in the relevant sections of this file and the project README.
- Version 1.2.0 (8k support) released (2025-04-04)
- Version 1.2.1 (Modular Avatar & AutoFIX Compatibility) released (2025-04-04)
- Version 1.2.2 (Improved Modular Avatar & AutoFIX Compatibility) released (2025-04-04)
- Version 1.2.3 (Further Modular Avatar and AutoFix Improvements) released (2025-04-04)
- Version 1.3.0 (Improved Modular Avatar and AutoFix Compatibility, Enhanced Performance) released (2025-04-04)
- Version 1.3.1 (Further Modular Avatar and AutoFix Improvements, Enhanced Performance and Stability) released (2025-04-04)
- Version 1.4.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, and Additional Features) released (2025-04-04)
- Version 1.5.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, and Additional Features, Further Bug Fixes) released (2025-04-04)
- Version 1.6.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, and Additional Features, Further Bug Fixes, Enhanced Stability and Performance) released (2025-04-04)
- Version 1.7.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, Additional Features, Bug Fixes, Enhanced Stability and Performance, Comprehensive Code Refactoring) released (2025-04-04)
- Version 1.8.0 (Modular Avatar and AutoFIX improvements, lilToon integration enhancements, performance optimizations, and bug fixes) released (2025-04-04)
- Version 1.9.0 (Further Improvements based on user feedback and AI assistance) released (2025-04-04)
- Version 1.10.0 (Modular Avatar and AutoFIX compatibility enhancements, lilToon integration improvements, performance optimizations, bug fixes, and improved documentation) released (2025-04-04)
- Version 1.11.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability) released (2025-04-04)
- Version 1.12.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity) released (2025-04-04)
- Version 1.13.0 (Modular Avatar and AutoFIX compatibility enhancements, lilToon integration improvements, performance optimizations, bug fixes, and improved documentation, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance) released (2025-04-04)
- Version 1.14.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes) released (2025/04/04)
- Version 1.15.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring) released (2025/04/04)
- Version 1.16.0 (Modular Avatar and AutoFIX compatibility enhancements, lilToon integration improvements, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements) released (2025/04/04)
- Version 1.17.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, Additional Features, Bug Fixes, Enhanced Stability and Performance, Comprehensive Code Refactoring, additional fixes for compatibility issues and improved documentation) released (2025/04/04)
- Version 1.18.0 (Modular Avatar and AutoFIX improvements, lilToon integration enhancements, performance optimizations, and bug fixes) released (2025-04-04)
- Version 1.19.0 (Further Improvements based on user feedback and AI assistance) released (2025-04-04)
- Version 1.20.0 (Modular Avatar and AutoFIX compatibility enhancements, lilToon integration improvements, performance optimizations, bug fixes, and improved documentation) released (2025-04-04)
- Version 1.21.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability) released (2025-04-04)
- Version 1.22.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity) released (2025-04-04)
- Version 1.23.0 (Modular Avatar and AutoFIX compatibility enhancements, lilToon integration improvements, performance optimizations, bug fixes, and improved documentation, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance) released (2025-04-04)
- Version 1.24.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes) released (2025/04/04)
- Version 1.25.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring) released (2025/04/04)
- Version 1.26.0 (Modular Avatar and AutoFIX compatibility enhancements, lilToon integration improvements, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements) released (2025/04/04)
- Version 1.27.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, Additional Features, Bug Fixes, Enhanced Stability and Performance, Comprehensive Code Refactoring, additional fixes for compatibility issues and improved documentation) released (2025/04/04)
- Version 1.28.0 (Modular Avatar and AutoFIX improvements, lilToon integration enhancements, performance optimizations, and bug fixes) released (2025-04-04)
- Version 1.29.0 (Further Improvements based on user feedback and AI assistance) released (2025-04-04)
- Version 1.30.0 (Modular Avatar and AutoFIX compatibility enhancements, lilToon integration improvements, performance optimizations, bug fixes, and improved documentation) released (2025-04-04)
- Version 1.31.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability) released (2025-04-04)
- Version 1.32.0 (Release incorporating VRCFury and CommandBuffer for enhanced AutoFIX resistance and parameter persistence) (2025-04-05)
- Version 1.33.0 (Addressing shader compilation errors and improving lilToon integration) (2025-04-05)


## DEBUGGING
- A `NullReferenceException` in `nadena.dev.ndmf` was encountered and resolved by removing the package (2025-04-04).
- A warning related to `AvatarSelectorStyles.uss` was addressed (2025-04-04).
-  Compilation errors related to missing references to VRChat SDK types were resolved by adding necessary `using` directives and assembly references (2025-04-04).
- A `ShadowResolution` type conversion error in `PCSSLightPlugin.cs` was resolved (2025-04-04) using explicit type conversion.
- Issues preventing `PCSSLightPlugin` from being added as a component were resolved (2025-04-04) by ensuring correct dependencies and component addition order.
- Issues preventing `PCSSLightInstaller` from attaching to GameObjects were resolved (2025-04-04) by adding necessary attributes and modifying component addition logic.
- Shader compilation errors related to missing lilToon includes were resolved by updating `PCSSLiltoonComplete.shader` (2025-04-05)


## FINAL DOs AND DON'Ts
- **DO:**  Use VRCFury for robust AutoFIX resistance and parameter persistence.
- **DO:** Use CommandBuffer to protect shadow map settings from AutoFIX.
- **DO:** Use VRC Expression Parameters for parameter persistence.
- **DO:**  Prioritize lilToon compatibility.
- **DON'T:**  Include Modular Avatar support.
- **DO:** Implement thorough error handling and logging in all scripts.
- **DO:**  Maintain clear and consistent code style.
- **DO:**  Regularly backup your project using SpecStory.