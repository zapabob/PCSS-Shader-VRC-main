
## PROJECT OVERVIEW
This project aims to develop a high-quality PCSS shader for VRChat, compatible with modular avatars and resistant to AutoFIX removal.  The shader will provide improved lighting and shadows within the VRChat environment.  The shader must be compatible with VRCFury's auto-correction features. The shader must maintain functionality even when the avatar is rebuilt.  The project incorporates nadena.dev.modular_avatar.core and nadena.dev.ndmf for robust modular avatar support and AutoFIX resistance, leveraging VRCFury's features for parameter persistence and mirror synchronization where appropriate.  The project structure is organized to improve maintainability and follow Unity best practices.  All scripts must be designed to work seamlessly with modular avatars and resist removal by VRChat's AutoFIX feature. Implementations should leverage VRCFury's features for parameter persistence and mirror synchronization.  The project now utilizes a more organized folder structure to improve maintainability and clarity.  The project is structured to facilitate Modular Avatar compatibility and AutoFIX resistance.  All shaders and scripts are designed for seamless integration with modular avatar systems and to prevent removal by VRChat's AutoFIX feature.  Refactoring was performed on 2025-04-04 to improve code clarity, maintainability, and address compilation errors related to Modular Avatar integration.  Further refactoring was performed on 2025-04-04 to improve code clarity and address compilation errors related to Modular Avatar integration and namespace conflicts.  The `PCSSLight` class namespace was changed from `PCSSLight.Core` to `PCSS.Core` to resolve naming conflicts.  A decision was made on 2025-04-04 to prioritize lilToon compatibility over full modular avatar support.

## CODE STYLE
Adhere to C# coding conventions.  Maintain consistent indentation and naming conventions.  Private variables should use the "_" prefix (e.g., `_myVariable`).

## FOLDER ORGANIZATION
The project follows the structure:
```
Assets/
└── PCSS-Shader/
    ├── Scripts/
    │   ├── Core/
    │   │   ├── PCSSLightPlugin.cs        # PCSS中核機能
    │   │   ├── PCSSLightInstaller.cs     # インストーラー
    │   │   └── PCSS.Core.asmdef         # コア機能のアセンブリ定義
    │   └── Utils/
    │       ├── PoissonTools.cs          # ポアソンディスク計算
    │       ├── SetCameraDepth.cs        # カメラ深度設定
    │       └── PCSS.Utils.asmdef         # ユーティリティのアセンブリ定義
    ├── Shaders/
    │   ├── PCSSLiltoonShader.shader    # PCSSシェーダー
    │   └── PCSS.Shaders.asmdef         # シェーダーのアセンブリ定義
    ├── Samples/                         # サンプルシーンとデモ
    ├── Prefabs/                         # プレハブ
    ├── package.json                     # パッケージ情報
    └── README.md                        # ドキュメント

```
This structure groups related files logically, clarifies dependencies, simplifies maintenance, and follows Unity best practices. Assembly Definition files manage dependencies.  The `PCSS.Core.asmdef` file must include a reference to `nadena.dev.modular_avatar.core` for proper Modular Avatar integration.

## TECH STACK
- Unity
- C#
- VRChat SDK
- nadena.dev.modular_avatar.core (Added 2025-04-04)
- nadena.dev.ndmf (Added 2025-04-04)
- VRCFury (Added 2025-04-04)
- lilToon (Added 2025-04-04)

## PROJECT-SPECIFIC STANDARDS
- All shader code must be well-commented and easy to understand.
- All scripts must include error handling and logging.  Utilize try-catch blocks and log detailed error messages including stack traces.
- Compatibility with VRChat's AutoFIX is mandatory. Implementations should leverage VRCFury's features for parameter persistence and mirror synchronization where appropriate.
- Compatibility with VRCFury's auto-correction features is mandatory.
- Code must be designed to maintain functionality across avatar rebuilds.  Utilize MAComponent, MAParameter, and MAMergeAnimator for robust modular avatar support and AutoFIX resistance.  All scripts must be designed to work seamlessly with modular avatars and resist removal by VRChat's AutoFIX feature.  Implementations should leverage VRCFury's features for parameter persistence and mirror synchronization.  As of 2025-04-04, lilToon compatibility is prioritized over full modular avatar support.

## WORKFLOW & RELEASE RULES
- Use Git for version control.
- Follow the GitHub workflow outlined in the `.github` folder.
- Releases should be versioned and documented.
- Refactoring based on modular avatar documentation is required to improve readability (2025-04-04).  This specifically applies to `PCSSLightPlugin.cs`.  The refactored `PCSSLightPlugin.cs` should use more descriptive variable names, utilize constants for magic numbers, and improve error handling and logging.  Further refactoring was performed on 2025-04-04 to address compilation errors and improve code clarity and maintainability.  The refactored `PCSSLightPlugin.cs`  includes improved error handling, more descriptive variable names, and the use of constants instead of magic numbers (2025-04-04).  Additional refactoring was conducted on 2025-04-04 to address compilation errors and improve overall code quality.  The updated `PCSSLightPlugin.cs` includes enhanced error handling, improved variable naming, and the use of constants to replace magic numbers. The namespace was changed from `PCSSLight.Core` to `PCSS.Core` to resolve naming conflicts.  Additional refactoring was performed on 2025-04-04 to address compilation errors and improve code clarity and maintainability.  The `PCSSLight` class namespace was changed from `PCSSLight.Core` to `PCSS.Core` to resolve naming conflicts.  A decision was made on 2025-04-04 to prioritize lilToon compatibility over full modular avatar support.  This impacts refactoring efforts going forward.

## REFERENCE EXAMPLES
- Refer to the `PCSSLightInstaller.cs`, `PCSSLight.cs`, `PCSSLightPlugin.cs`, and `PCSSLiltoonShader.shader` files for example implementations of modular avatar compatibility and AutoFIX resistance. These files utilize nadena.dev.modular_avatar.core and nadena.dev.ndmf for robust modular avatar support and AutoFIX resistance. Implementations leverage VRCFury's features for parameter persistence and mirror synchronization where appropriate.  `PoissonTools.cs` provides Poisson disk sampling for optimized shadow calculations. `SetCameraDepth.cs` manages camera depth settings for PCSS shadow rendering.  The refactored `PCSSLightPlugin.cs` serves as a prime example of best practices for modular avatar integration and AutoFIX resistance.  As of 2025-04-04, lilToon compatibility is prioritized over full modular avatar support.

## PROJECT DOCUMENTATION & CONTEXT SYSTEM
- Documentation is maintained in markdown format.
- Version updates will be noted in the relevant sections of this file and the project README.
- Version 1.2.0 (8k support) released (2025-04-04)
- Version 1.2.1 (Modular Avatar & AutoFix Compatibility) released (2025-04-04)
- Version 1.2.2 (Improved Modular Avatar & AutoFix Compatibility) released (2025-04-04)
- Version 1.2.3 (Further Modular Avatar and AutoFix Improvements) released (2025-04-04)
- Version 1.3.0 (Improved Modular Avatar and AutoFix Compatibility, Enhanced Performance) released (2025-04-04)
- Version 1.3.1 (Further Modular Avatar and AutoFix Improvements, Enhanced Performance and Stability) released (2025-04-04)
- Version 1.4.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, and Additional Features) released (2025-04-04)
- Version 1.5.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, and Additional Features, Further Bug Fixes) released (2025-04-04)
- Version 1.6.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, and Additional Features, Further Bug Fixes, Enhanced Stability and Performance) released (2025-04-04)
- Version 1.7.0 (Improved lilToon Integration, Enhanced Modular Avatar Support, Additional Features, Bug Fixes, Enhanced Stability and Performance, Comprehensive Code Refactoring) released (2025-04-04)
- Version 1.8.0 (Modular Avatar and AutoFix improvements, lilToon integration enhancements, performance optimizations, and bug fixes) released (2025-04-04)
- Version 1.9.0 (Further Improvements based on user feedback and AI assistance) released (2025-04-04)
- Version 1.10.0 (Modular Avatar and AutoFix compatibility enhancements, lilToon integration improvements, performance optimizations, bug fixes, and improved documentation) released (2025-04-04)
- Version 1.11.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability) released (2025-04-04)
- Version 1.12.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity) released (2025-04-04)
- Version 1.13.0 (Modular Avatar and AutoFix compatibility enhancements, lilToon integration improvements, performance optimizations, bug fixes, and improved documentation, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance) released (2025-04-04)
- Version 1.14.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes) released (2025/04/04)
- Version 1.15.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring) released (2025/04/04)
- Version 1.16.0 (Modular Avatar and AutoFix compatibility enhancements, lilToon integration improvements, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements) released (2025/04/04)
- Version 1.17.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation) released (2025/04/04)
- Version 1.18.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance) released (2025/04/04)
- Version 1.19.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance) released (2025/04/04)
- Version 1.20.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback) released (2025/04/04)
- Version 1.21.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance) released (2025/04/04)
- Version 1.22.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements) released (2025/04/04)
- Version 1.23.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements) released (2025/04/04)
- Version 1.24.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation) released (2025/04/04)
- Version 1.25.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance) released (2025/04/04)
- Version 1.26.0 (Modular Avatar and AutoFix compatibility enhancements, lilToon integration improvements, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance) released (2025/04/04)
- Version 1.27.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation) released (2025/04/04)
- Version 1.28.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation) released (2025/04/04)
- Version 1.29.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation) released (2025/04/04)
- Version 1.30.0 (Further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, addressing compilation errors and enhancing stability, improved code structure and modularity, and further improvements based on user feedback and AI assistance, and additional bug fixes, and complete code refactoring and restructuring, and additional bug fixes and performance improvements, and additional fixes for compatibility issues and improved documentation, and additional fixes for compilation errors and improved performance, and addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance) released (2025/04/04)
- Version 1.31.0 (Addressing remaining compilation errors and improving overall stability and performance, and additional bug fixes and improvements based on user feedback, and addressing remaining issues and improving overall stability and performance, and further bug fixes and improvements, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance, and additional fixes for compatibility issues and improved documentation, and addressing remaining issues and improving overall stability and performance) released (2025/04/04)
- Version 1.32.0 (lilToon compatibility prioritized over full modular avatar support) (2025-04-04)


## DEBUGGING
Standard Unity debugging techniques should be used.  Log errors and warnings to the console for easier troubleshooting.  Utilize robust error handling and logging within all scripts. Include stack traces in error logs for more efficient debugging.

## FINAL DOs AND DON'Ts
- **DO** use the provided code examples as a starting point for development.
- **DO** thoroughly test your code before committing changes, ensuring compatibility with both modular avatars and AutoFIX, as well as VRCFury's auto-correction features and maintaining functionality across avatar rebuilds.  Prioritize lilToon compatibility as of 2025-04-04.
- **DO** ensure compatibility with modular avatars and AutoFIX using MAComponent, MAParameter, and MAMergeAnimator where appropriate.  This is secondary to lilToon compatibility as of 2025-04-04.
- **DO** leverage VRCFury's features for enhanced AutoFIX resistance and mirror synchronization.
- **DO** follow the updated code style guidelines, including the use of "_" prefixes for private variables.
- **DON'T** commit incomplete or untested code.
- **DON'T** introduce breaking changes without thorough testing and documentation.
- **DON'T** use magic numbers; define constants instead.